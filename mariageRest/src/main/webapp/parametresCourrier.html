<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		
		<title>Mariage</title>
		
		<link rel="stylesheet" href="ressources/jquery-ui-1.11.4.custom/jquery-ui.min.css" />
		<link rel="stylesheet" href="ressources/bootstrap-3.3.6-dist/css/bootstrap.min.css" />
		<link rel="stylesheet" href="ressources/bootstrap-datetimepicker-master/bootstrap-datetimepicker.min.css"/>
		<link rel="stylesheet" href="ressources/jqwidgets-ver4.1.1/jqx.base.css" />
		<link rel="stylesheet" href="ressources/custom.css" />
	</head>
	<body>
		<div class="container-fluid">

			<!-- Colonne gauche -->
			<div class="header col-md-3">
				<div data-w3-include-html="./part_menu.html"></div> 
			</div>
			
			<div class="content col-md-9">
			
				<div data-w3-include-html="./part_infoMariage.html"></div>

				<div id="courriers"></div>

				<button id="button_afficher_popup_ajouter_courrier" class="btn btn-default">Ajouter un courrier</button>
				
				<div id="popupAjoutCourrier" class="popup">
					<div>Ajout d'un courrier</div>
					<div class="form-inline">
						<form>
							<div class="form-group"><label for="courrier_nom">Nom</label><input type="text" class="form-control" id="courrier_nom" name="nom"  placeholder="Nom" required/></div>
							<div class="form-group"><label for="courrier_datePrevisionEnvoi"></label><input type="text" class="form-control datePicker" id="courrier_datePrevisionEnvoi" name="datePrevisionEnvoi"  placeholder="Date envoi prévu" required/></div>
							<div class="form-group"><label for="courrier_dateEnvoiRealise"></label><input type="text" class="form-control datePicker" id="courrier_dateEnvoiRealise" name="dateEnvoiRealise"  placeholder="Date envoi réalisé"/></div>
							<br/><button id="button_ajouter_courrier" class="btn btn-default">Ajouter</button>
						</form>
					</div>
				</div>
			</div>
		</div>

		<script type="text/javascript" src="ressources/all.js"></script>
		<script type="text/javascript" src="ressources/common.js"></script>
		<script type="text/javascript">
		var donneesDejaChargees = false;
		
		// Affiche la popup des invités
		var affichePopupCourrier = function() { $("#popupAjoutCourrier").jqxWindow('open'); };

		// Fonction JqxGrid
		var modifieCourrier = function(e) {
			majAttribute(REST_PREFIX + "/mariage/" + idMariage + "/courrier", e, chargeCourriers);
		}
		
		// Sauvegarde courrier par un POST
		var ajouteCourrier = function(e) {
			e.preventDefault();
			
			valideForm("#popupAjoutCourrier form", function(data) {
				var req = $.ajax({ type: "POST", url: REST_PREFIX + "/mariage/" + idMariage + "/courrier", data: data});
				req.success(function(dataString) {
					$("#popupAjoutCourrier").jqxWindow("close");
					chargeCourriers();
				});
				req.fail(function(jqXHR, textStatus, errorThrown) {ajaxFailFunctionToDisplayWarn("ajouteCourrier");});
			});
		};
		
		
		var supprimeCourrier = function(idCourrier) {
			var req = $.ajax({ type: "DELETE", url: REST_PREFIX + "/mariage/" + idMariage + "/courrier/" + idCourrier});
			req.success(function(dataString) { chargeCourriers(); });
			req.fail(function(jqXHR, textStatus, errorThrown) {ajaxFailFunctionToDisplayWarn("supprimeCourrier");});
		};
		
		// Chargement des courriers
		var chargeCourriers = function() {
			if (donneesDejaChargees) {
				$("#courriers").jqxGrid('updatebounddata', 'cells');
			} else {
				var dataAdapter = new $.jqx.dataAdapter({
					datatype: "json",
					url: REST_PREFIX + "/mariage/" + idMariage + "/courrier",
					datafields: [{ name: 'id', type: 'string' },{ name: 'nom', type: 'string' },{ name: 'dateEnvoiRealise', type: 'string' },{ name: 'datePrevisionEnvoi', type: 'string' }],
					id: 'id'
				});
				var rendererColonneBouton = function (rowIndex, columnfield, value, defaulthtml, columnproperties) { return '<a href="javascript:supprimeCourrier(' + value + ')" id="btn' + value + '"><span class="ui-icon ui-icon-trash"></span></a>' };
				$("#courriers").jqxGrid({
					source: dataAdapter,
					columns: [
						{ text: 'Nom', datafield: 'nom', width: "30%" },
						{ text: 'Date envoi prévu', datafield: 'datePrevisionEnvoi', width: "30%" },
						{ text: 'Date envoi réalisé', datafield: 'dateEnvoiRealise', width: "30%" },
						{ text: 'Actions', datafield: 'id', width: "10%", editable: false, sortable: false, menu: false, cellsrenderer: rendererColonneBouton }
					],
					editable: true,
					sortable: true,
					filterable: true,
					autoheight: true,
					width: 950
				});
				$("#courriers").on('cellendedit', modifieCourrier);
				donneesDejaChargees = true;
			}
		};

		$(document).ready(function() {
		
			// Init
			chargeCourriers();
			
			// Ajout des evenements
			$("#button_afficher_popup_ajouter_courrier").on("click", affichePopupCourrier);
			$("#button_ajouter_courrier").on("click", ajouteCourrier);
		});
		</script>
	</body>
</html>