<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		
		<title>Mariage</title>
		
		<link rel="stylesheet" href="ressources/jquery-ui-1.11.4.custom/jquery-ui.min.css" />
		<link rel="stylesheet" href="ressources/bootstrap-3.3.6-dist/css/bootstrap.min.css" />
		<link rel="stylesheet" href="ressources/bootstrap-datepicker-1.5.1-dist/css/bootstrap-datepicker3.min.css" />
		<link rel="stylesheet" href="ressources/jqwidgets-ver4.1.1/jqx.base.css" />
		<link rel="stylesheet" href="ressources/custom.css" />
	</head>
	<body>
		<div class="container-fluid">

			<!-- Colonne gauche -->
			<div class="header col-md-3">
				<!-- Titre -->
				<div class="row text-center titre">MonMariage.net</div>
				<!-- Menu -->
				<div class="navbar navbar-default" role="navigation">
					<ul class="nav nav-pills nav-stacked">
						<li><a href="index.html">Accueil</a></li>
						<li><a href="parametres.html">Paramètres</a></li>
						<li class="active"><a href="invitation.html">Invitation</a></li>
						<li><a href="contact.html">Adresse et téléphone</a></li>
						<li><a href="courrier.html">Courriers</a></li>
						<li><a href="reponse.html">Réponses</a></li>
					</ul>
				</div>
				<!-- Version -->
				<div class="row text-center">version 1.0.0</div>
			</div>
			
			<div class="content col-md-9">
			
				<div id="infoMariage" class="text-center">
					<h1>Gestionnaire de mariage.</h1>
					<div id="maries">Mariage de <span></span> & <span></span></div>
					<div id="date">le <span></span></div>
				</div>
			
				<div id="invites"></div>
				
				<button id="button_afficher_popup_ajouter" class="btn btn-default">Ajouter</button>
				
				<div id="popupAjoutInvite" class="popup">
					<div class="form-inline">
						<form>
							<div class="form-group">
								<label for="nom">Nom</label>
								<input type="text" class="form-control" id="nom" name="nom"  placeholder="Nom" />
							</div>
							<div class="form-group">
								<label for="prenom">Prenom</label>
								<input type="text" class="form-control" id="prenom" name="prenom" placeholder="Prenom"/>
							</div>
							<div class="form-group">
								<label for="groupe">Groupe</label>
								<input type="text" class="form-control" id="groupe" name="groupe" placeholder="Groupe"/>
							</div>
							<button id="button_ajouter" class="btn btn-default">Ajouter</button>
						</form>
					</div>
				</div>
			</div>
		</div>

		<script type="application/javascript" src="ressources/jquery-ui-1.11.4.custom/external/jquery/jquery.js"></script>
		<script type="application/javascript" src="ressources/jquery-ui-1.11.4.custom/jquery-ui.min.js"></script>
		<script type="application/javascript" src="ressources/bootstrap-datepicker-1.5.1-dist/js/bootstrap-datepicker.min.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxcore.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxbuttons.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxscrollbar.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxmenu.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxgrid.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxgrid.edit.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxgrid.selection.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxgrid.columnsresize.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxgrid.filter.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxgrid.sort.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxdata.js"></script> 
		<script type="application/javascript" src="ressources/jqwidgets-ver4.1.1/jqxscrollbar.js"></script>
		<script type="application/javascript" src="ressources/jqwidgets-ver4.1.1/jqxdropdownlist.js"></script>
		<script type="application/javascript" src="ressources/jqwidgets-ver4.1.1/jqxlistbox.js"></script>
		<script type="application/javascript" src="ressources/common.js"></script>
		<script type="application/javascript">
			var idMariage = "";
			var donneesDejaChargees = false;
			
			// Affiche la popup des invités
			var affichePopupInvite = function() {
				$("#popupAjoutInvite").dialog("open");
			};

			// Fonction JqxGrid
			var modifieInvite = function(e) {
				majAttribute(REST_PREFIX + "/mariage/" + idMariage + "/invite", e, chargeInvites);
			}
			
			// Sauvegarde invité par un POST
			var ajouteInvite = function(e) {
				e.preventDefault();
				
				var data = $("#popupAjoutInvite form").serialize();
				var req = $.ajax({ type: "POST", url: REST_PREFIX + "/mariage/" + idMariage + "/invite", data: data});
				req.success(function(dataString) {
					$("#popupAjoutInvite").dialog("close");
					chargeInvites();
				});
				req.fail(function(jqXHR, textStatus, errorThrown) {ajaxFailFunctionToDisplayWarn("ajouteInvite");});
			};
			
			var supprimeInvite = function(idInvite) {
				var req = $.ajax({ type: "DELETE", url: REST_PREFIX + "/mariage/" + idMariage + "/invite/" + idInvite});
				req.success(function(dataString) { chargeInvites(); });
				req.fail(function(jqXHR, textStatus, errorThrown) {ajaxFailFunctionToDisplayWarn("ajouteInvite");});
			};
			
			// Chargement des données du mariage
			var chargeDonneesMariage = function() {
				var req = $.get( REST_PREFIX + "/mariage/" + idMariage);
				req.success(function(dataString) {
					var data = eval(dataString);
					$("#maries span:first").html(data.marie1);
					$("#maries span:last").html(data.marie2);
					$("#date span").html(data.dateCelebration);
				});
				req.fail(function(jqXHR, textStatus, errorThrown) {ajaxFailFunctionToDisplayWarn("readMariage");});
			};

			// Chargement des invites
			var chargeInvites = function() {
				if (donneesDejaChargees) {
					$("#invites").jqxGrid('updatebounddata', 'cells');
				} else {
					var dataAdapter = new $.jqx.dataAdapter({
						datatype: "json",
						url: REST_PREFIX + "/mariage/" + idMariage + "/invite",
						datafields: [{ name: 'id', type: 'string' },{ name: 'groupe', type: 'string' },{ name: 'nom', type: 'string' }],
						id: 'id'
					});
					var rendererColonneBouton = function (rowIndex, columnfield, value, defaulthtml, columnproperties) { return '<a href="javascript:supprimeInvite(' + value + ')" id="btn' + value + '"><span class="ui-icon ui-icon-trash"></span></a>' };
					$("#invites").jqxGrid({
						source: dataAdapter,
						columns: [
							{ text: 'Nom', datafield: 'nom', width: "45%" },
							{ text: 'Groupe', datafield: 'groupe', width: "45%" },
							{ text: 'Actions', datafield: 'id', width: "10%", editable: false, sortable: false, menu: false, cellsrenderer: rendererColonneBouton }
						],
						editable: true,
						sortable: true,
						filterable: true,
						autoheight: true,
						width: 950
					});
					$("#invites").on('cellendedit', modifieInvite);
					donneesDejaChargees = true;
				}
			};

			$(document).ready(function() {
			
				// Redirection si pas de mariage sélectionné
				idMariage = getIdMariage();
				if (idMariage === "") {window.location.href="/";}
				
				chargeDonneesMariage();

				chargeInvites();
				
				// Ajout des evenements
				$("#button_afficher_popup_ajouter").on("click", affichePopupInvite);
				$("#button_ajouter").on("click", ajouteInvite);
			});
		</script>
	</body>
</html>