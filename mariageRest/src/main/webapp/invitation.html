<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		
		<title>Mariage</title>
		
		<link rel="stylesheet" href="ressources/jquery-ui-1.11.4.custom/jquery-ui.min.css" />
		<link rel="stylesheet" href="ressources/bootstrap-3.3.6-dist/css/bootstrap.min.css" />
		<link rel="stylesheet" href="ressources/bootstrap-datepicker-1.5.1-dist/css/bootstrap-datepicker3.min.css" />
		<link rel="stylesheet" href="ressources/jqwidgets-ver4.1.1/jqx.base.css" />
		<link rel="stylesheet" href="ressources/custom.css" />
	</head>
	<body>
		<div class="container-fluid">

			<!-- Colonne gauche -->
			<div class="header col-md-3">
				<div data-w3-include-html="./part_menu.html"></div> 
			</div>
			
			<div class="content col-md-9">
			
				<div data-w3-include-html="./part_infoMariage.html"></div>
				<script type="text/javascript" src="./part_infoMariage.js"></script>

				<div id="invites"></div>

				<button id="button_afficher_popup_ajouter" class="btn btn-default">Ajouter</button>
				
				<div id="popupAjoutInvite" class="popup">
					<div>Ajout d'un invité</div>
					<div class="form-inline">
						<form>
							<div class="form-group">
								<label for="groupe">Groupe</label>
								<input type="text" class="form-control" id="groupe" name="groupe" placeholder="Groupe" required/>
							</div>
							<div class="form-group">
								<label for="foyer">Foyer</label>
								<input type="text" class="form-control" id="foyer" name="foyer" placeholder="Foyer" required/>
							</div>
							<div class="form-group">
								<label for="nom">Nom</label>
								<input type="text" class="form-control" id="nom" name="nom"  placeholder="Nom" required/>
							</div>
							<div class="form-group">
								<label for="prenom">Prenom</label>
								<input type="text" class="form-control" id="prenom" name="prenom" placeholder="Prenom" required/>
							</div>
							<div class="form-group">
								<label for="age">Age</label>
								<select class="form-control" id="age" name="age" data-source="/parametres/age" data-empty="false" required></select>
							</div>
							<br/><button id="button_ajouter" class="btn btn-default">Ajouter</button>
						</form>
					</div>
				</div>
			</div>
		</div>

		<script type="text/javascript" src="ressources/w3-include-HTML.js"></script> 
		<script type="text/javascript" src="ressources/jquery-ui-1.11.4.custom/external/jquery/jquery.js"></script>
		<script type="text/javascript" src="ressources/jquery-ui-1.11.4.custom/jquery-ui.min.js"></script>
		<script type="text/javascript" src="ressources/bootstrap-datepicker-1.5.1-dist/js/bootstrap-datepicker.min.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxcore.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxbuttons.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxscrollbar.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxmenu.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxgrid.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxgrid.edit.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxgrid.selection.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxgrid.columnsresize.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxgrid.filter.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxgrid.sort.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxdata.js"></script> 
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxscrollbar.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxdropdownlist.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxlistbox.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxwindow.js"></script>
		<script type="text/javascript" src="ressources/common.js"></script>
		<script type="text/javascript">
			var donneesDejaChargees = false;
			
			// Affiche la popup des invités
			var affichePopupInvite = function() {
				$("#popupAjoutInvite").jqxWindow('open');
			};

			// Fonction JqxGrid
			var modifieInvite = function(e) {
				majAttribute(REST_PREFIX + "/mariage/" + idMariage + "/invite", e, chargeInvites);
			}
			
			// Sauvegarde invité par un POST
			var ajouteInvite = function(e) {
				e.preventDefault();
				
				valideForm("#popupAjoutInvite form", function(data) {
					var req = $.ajax({ type: "POST", url: REST_PREFIX + "/mariage/" + idMariage + "/invite", data: data});
					req.success(function(dataString) {
						$("#popupAjoutInvite").jqxWindow("close");
						chargeInvites();
					});
					req.fail(function(jqXHR, textStatus, errorThrown) { ajaxFailFunctionToDisplayWarn("ajouteInvite"); });
				});
			};
			
			var supprimeInvite = function(idInvite) {
				var req = $.ajax({ type: "DELETE", url: REST_PREFIX + "/mariage/" + idMariage + "/invite/" + idInvite});
				req.success(function(dataString) { chargeInvites(); });
				req.fail(function(jqXHR, textStatus, errorThrown) {ajaxFailFunctionToDisplayWarn("ajouteInvite");});
			};
			
			// Au changement de presence
			var changePresence = function(idPresenceEtape, valeur) {
				var data = { id: idPresenceEtape, presence: valeur};
				var req = $.post( REST_PREFIX + "mariage/" + idMariage + "/presenceEtape", data);
				req.success(function(dataString) { });
				req.fail(function(jqXHR, textStatus, errorThrown) {ajaxFailFunctionToDisplayWarn("changePresence");  });
			}

			// Chargement des invites
			var chargeInvites = function() {
				if (donneesDejaChargees) {
					$("#invites").jqxGrid('updatebounddata', 'cells');
				} else {
					
					// Chargement des étapes
					var req = $.get( REST_PREFIX + "mariage/" + getIdMariage() + "/etape");
					req.fail(function(jqXHR, textStatus, errorThrown) {ajaxFailFunctionToDisplayWarn("chargeInvites");});
					req.success(function(dataString) {
						
						// Avec les étapes
						var etapes = eval(dataString);
						
						// Render de la colonne des boutons pour un bouton supprimer se basant sur l'id de l'invite
						var rendererColonneBouton = function (rowIndex, columnfield, value, defaulthtml, columnproperties, rowData) {  return '<div class="center"><a href="javascript:supprimeInvite(' + value + ')" id="btn' + value + '"><span class="ui-icon ui-icon-trash"></span></a></div>'; };
						
						// Render des colonnes d'étape se basant sur LES CHAMPS liés à une étape
						var rendererColonnePresence = function (rowIndex, columnfield, value, defaulthtml, columnproperties, rowData) { var idEtape = columnfield.substring("presencesEtape".length); var idPresenceEtape = rowData["presencesEtape_ID" + idEtape]; return '<div class="center"><input type="checkbox" onchange="changePresence(' + idPresenceEtape + ', this.checked)" ' + (value?'checked':'') + '/></div>'; };
						
						// Champs fixes
						var datafields = [
							{ name: 'id', type: 'string' },
							{ name: 'groupe', type: 'string' },{ name: 'foyer', type: 'string' },
							{ name: 'nom', type: 'string' },{ name: 'prenom', type: 'string' }
						];
						
						// Calcul des largeurs des 4 colonnes fixes (7% pour les actions et 10% par etape)
						var largeur = 10;
						if (etapes.length > 0) { largeur = (100 - 7 - 10 * etapes.length) / 4; }
						largeur = largeur + "%";
						
						// Colonnes fixes
						var columns = [
							{ text: 'Groupe', datafield: 'groupe', width: largeur, align: "center" }, { text: 'Foyer', datafield: 'foyer', width: largeur, align: "center" },
							{ text: 'Nom', datafield: 'nom', width: largeur, align: "center" }, { text: 'Prenom', datafield: 'prenom', width: largeur, align: "center" }
						];
						
						// Pour chaque étape, 
						etapes.forEach(function(e, i, array) {
							// un champ avec la présence (clef du champ contenant l'idEtape pour être cohérent dans toutes les lignes)
							datafields.push({ name: 'presencesEtape' + e.id, type: 'string', map: 'presencesEtape>' + i + '>presence' });
							// un champ avec la valeur de l'idPresenceEtape (clef du champ contenant toujours l'idEtape)
							datafields.push({ name: 'presencesEtape_ID' + e.id, type: 'string', map: 'presencesEtape>' + i + '>idPresenceEtape' });
							// colonne utilisant le render custo
							columns.push({ text: e.nom, datafield: 'presencesEtape' + e.id, editable: false, width: "10%", align: "center", cellsrenderer: rendererColonnePresence });
						});
						
						// colonne action pour finir
						columns.push({ text: 'Actions', datafield: 'id', width: "7%", editable: false, sortable: false, menu: false, align: "center", cellsrenderer: rendererColonneBouton });
						
						// Appel JqGrid
						var dataAdapter = new $.jqx.dataAdapter({ datatype: "json", url: REST_PREFIX + "/mariage/" + idMariage + "/invite", datafields: datafields, id: 'id' });
						$("#invites").jqxGrid({ source: dataAdapter, columns: columns, editable: true, sortable: true, filterable: true, autoheight: true, width: 950 });
						$("#invites").on('cellendedit', modifieInvite);
						donneesDejaChargees = true;
					});
				}
			};

			$(document).ready(function() {
				// Init
				chargeInvites();
				
				// Ajout des evenements
				$("#button_afficher_popup_ajouter").on("click", affichePopupInvite);
				$("#button_ajouter").on("click", ajouteInvite);
			});
		</script>
	</body>
</html>