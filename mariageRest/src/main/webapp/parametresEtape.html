<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		
		<title>Mariage</title>
		
		<link rel="stylesheet" href="ressources/jquery-ui-1.11.4.custom/jquery-ui.min.css" />
		<link rel="stylesheet" href="ressources/bootstrap-3.3.6-dist/css/bootstrap.min.css" />
		<link rel="stylesheet" href="ressources/bootstrap-datetimepicker-master/bootstrap-datetimepicker.min.css"/>
		<link rel="stylesheet" href="ressources/jqwidgets-ver4.1.1/jqx.base.css" />
		<link rel="stylesheet" href="ressources/custom.css" />
	</head>
	<body>
		<div class="container-fluid">

			<!-- Colonne gauche -->
			<div class="header col-md-3">
				<div data-w3-include-html="./part_menu.html"></div> 
			</div>
			
			<div class="content col-md-9">
			
				<div data-w3-include-html="./part_infoMariage.html"></div>
				<script type="text/javascript" src="./part_infoMariage.js"></script>

				<div id="etapes"></div>

				<button id="button_afficher_popup_ajouter_repas" class="btn btn-default">Ajouter un repas</button>
				<button id="button_afficher_popup_ajouter_ceremonie" class="btn btn-default">Ajouter une cérémonie</button>
				
				<div id="popupAjoutEtapeCeremonie" class="popup">
					<div>Ajout d'une cérémonie</div>
					<div class="form-inline">
						<form>
							<input type="hidden" name="type" value="EtapeCeremonie"/>
							<div class="form-group"><label for="cere_nom">Nom</label><input type="text" class="form-control" id="cere_nom" name="nom"  placeholder="Nom" required/></div>
							<div class="form-group"><label for="cere_lieu">Lieu</label><input type="text" class="form-control" id="cere_lieu" name="lieu"  placeholder="Lieu" required/></div>
							<div class="form-group"><label for="cere_dateHeure">Date et heure</label><input type="text" class="form-control dateTimePicker" id="cere_dateHeure" name="dateHeure"  placeholder="Date et heure" required/></div>
							<div class="form-group"><label for="cere_celebrant">Célébrant</label><input type="text" class="form-control" id="cere_celebrant" name="celebrant"  placeholder="Célébrant" required/></div>
							<br/><button id="button_ajouter_etapeCeremonie" class="btn btn-default">Ajouter</button>
						</form>
					</div>
				</div>
				<div id="popupAjoutEtapeRepas" class="popup">
					<div>Ajout d'un repas</div>
					<div class="form-inline">
						<form>
							<input type="hidden" name="type" value="EtapeRepas"/>
							<div class="form-group"><label for="repa_nom">Nom</label><input type="text" class="form-control" id="repa_nom" name="nom"  placeholder="Nom" required/></div>
							<div class="form-group"><label for="repa_lieu">Lieu</label><input type="text" class="form-control" id="repa_lieu" name="lieu"  placeholder="Lieu" required/></div>
							<div class="form-group"><label for="repa_dateHeure">Date et heure</label><input type="text" class="form-control dateTimePicker" id="repa_dateHeure" name="dateHeure"  placeholder="Date et heure" required/></div>
							<br/><button id="button_ajouter_etapeRepas" class="btn btn-default">Ajouter</button>
						</form>
					</div>
				</div>
			</div>
		</div>

		<script type="text/javascript" src="ressources/all.js"></script>
		<script type="text/javascript" src="ressources/common.js"></script>
		<script type="text/javascript">
		var donneesDejaChargees = false;
		
		// Affiche la popup des invités
		var affichePopupEtapeRepas = function() { $("#popupAjoutEtapeRepas").jqxWindow('open'); };
		var affichePopupEtapeCeremonie = function() { $("#popupAjoutEtapeCeremonie").jqxWindow('open'); };

		// Fonction JqxGrid
		var modifieEtape = function(e) {
			majAttribute(REST_PREFIX + "/mariage/" + idMariage + "/etape", e, chargeEtapes);
		}
		
		// Sauvegarde etape par un POST
		var ajouteEtape = function(e, idPopup) {
			e.preventDefault();
			
			valideForm("#" + idPopup + " form", function(data) {
				var req = $.ajax({ type: "POST", url: REST_PREFIX + "/mariage/" + idMariage + "/etape", data: data});
				req.success(function(dataString) {
					$("#" + idPopup).jqxWindow("close");
					chargeEtapes();
				});
				req.fail(function(jqXHR, textStatus, errorThrown) {ajaxFailFunctionToDisplayWarn("ajouteEtape");});
			});
		};
		var ajouteEtapeCeremonie = function(e) { ajouteEtape(e, "popupAjoutEtapeCeremonie") };
		var ajouteEtapeRepas = function(e) { ajouteEtape(e, "popupAjoutEtapeRepas") };
		
		
		var supprimeEtape = function(idEtape) {
			var req = $.ajax({ type: "DELETE", url: REST_PREFIX + "/mariage/" + idMariage + "/etape/" + idEtape});
			req.success(function(dataString) { chargeEtapes(); });
			req.fail(function(jqXHR, textStatus, errorThrown) {ajaxFailFunctionToDisplayWarn("supprimeEtape");});
		};
		
		// Chargement des etapes
		var chargeEtapes = function() {
			if (donneesDejaChargees) {
				$("#etapes").jqxGrid('updatebounddata', 'cells');
			} else {
				var dataAdapter = new $.jqx.dataAdapter({
					datatype: "json",
					url: REST_PREFIX + "/mariage/" + idMariage + "/etape",
					datafields: [{ name: 'id', type: 'string' },{ name: 'lieu', type: 'string' },{ name: 'nom', type: 'string' },{ name: 'type', type: 'string' },{ name: 'dateHeure', type: 'string' },{ name: 'numOrdre', type: 'string' }],
					id: 'id'
				});
				var rendererColonneBouton = function (rowIndex, columnfield, value, defaulthtml, columnproperties) { return '<a href="javascript:supprimeEtape(' + value + ')" id="btn' + value + '"><span class="ui-icon ui-icon-trash"></span></a>' };
				$("#etapes").jqxGrid({
					source: dataAdapter,
					columns: [
						{ text: 'Type', datafield: 'type', width: "15%", editable: false },
						{ text: 'Ordre', datafield: 'numOrdre', width: "5%" },
						{ text: 'Nom', datafield: 'nom', width: "25%" },
						{ text: 'Date et heure', datafield: 'dateHeure', width: "20%" },
						{ text: 'Lieu', datafield: 'lieu', width: "25%" },
						{ text: 'Actions', datafield: 'id', width: "10%", editable: false, sortable: false, menu: false, cellsrenderer: rendererColonneBouton }
					],
					editable: true,
					sortable: true,
					filterable: true,
					autoheight: true,
					width: 950
				});
				$("#etapes").on('cellendedit', modifieEtape);
				donneesDejaChargees = true;
			}
		};

		$(document).ready(function() {
		
			// Init
			chargeEtapes();
			
			// Ajout des evenements
			$("#button_afficher_popup_ajouter_ceremonie").on("click", affichePopupEtapeCeremonie);
			$("#button_afficher_popup_ajouter_repas").on("click", affichePopupEtapeRepas);
			$("#button_ajouter_etapeCeremonie").on("click", ajouteEtapeCeremonie);
			$("#button_ajouter_etapeRepas").on("click", ajouteEtapeRepas);
		});
		</script>
	</body>
</html>