<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		
		<title>Mariage</title>
		
		<link rel="stylesheet" href="ressources/jquery-ui-1.11.4.custom/jquery-ui.min.css" />
		<link rel="stylesheet" href="ressources/bootstrap-3.3.6-dist/css/bootstrap.min.css" />
		<link rel="stylesheet" href="ressources/bootstrap-datepicker-1.5.1-dist/css/bootstrap-datepicker3.min.css" />
		<link rel="stylesheet" href="ressources/jqwidgets-ver4.1.1/jqx.base.css" />
		<link rel="stylesheet" href="ressources/custom.css" />
	</head>
	<body>
		<div class="container-fluid">

			<!-- Colonne gauche -->
			<div class="header col-md-3">
				<!-- Titre -->
				<div class="row text-center titre">MonMariage</div>
				<!-- Menu -->
				<div class="navbar navbar-default" role="navigation">
					<ul class="nav nav-pills nav-stacked">
						<li><a href="index.html">Accueil</a></li>
						<li class="active"><a href="parametres.html">Paramètres</a></li>
						<li><a href="invitation.html">Invitation</a></li>
						<li><a href="contact.html">Adresse et téléphone</a></li>
						<li><a href="courrier.html">Courriers</a></li>
						<li><a href="reponse.html">Réponses</a></li>
					</ul>
				</div>
				<!-- Version -->
				<div class="row text-center">version 1.0.0</div>
			</div>
			
			<div class="content col-md-9">
			
				<div id="infoMariage" class="text-center">
					<h1>Gestionnaire de mariage.</h1>
					<div id="maries">Mariage de <span></span> & <span></span></div>
					<div id="date">le <span></span></div>
				</div>
				
				<div id="etapes"></div>
				
				<button id="button_afficher_popup_ajouter_repas" class="btn btn-default">Ajouter un repas</button>
				<button id="button_afficher_popup_ajouter_ceremonie" class="btn btn-default">Ajouter une cérémonie</button>
				
				<div id="popupAjoutEtapeCeremonie" class="popup">
					<div class="form-inline">
						<form>
							<input type="hidden" name="type" value="EtapeCeremonie"/>
							<div class="form-group">
								<label for="nom">Nom</label>
								<input type="text" class="form-control" id="nom" name="nom"  placeholder="Nom"/>
							</div>
							<div class="form-group">
								<label for="lieu">Lieu</label>
								<input type="text" class="form-control" id="lieu" name="lieu"  placeholder="Lieu"/>
							</div>
							<div class="form-group">
								<label for="dateHeure">Date et heure</label>
								<input type="text" class="form-control dateTimePicker" id="dateHeure" name="dateHeure"  placeholder="Date et heure"/>
							</div>
							<div class="form-group">
								<label for="celebrant">Célébrant</label>
								<input type="text" class="form-control" id="celebrant" name="celebrant"  placeholder="Célébrant"/>
							</div>
							<button id="button_ajouter_etapeCeremonie" class="btn btn-default">Ajouter</button>
						</form>
					</div>
				</div>
				<div id="popupAjoutEtapeRepas" class="popup">
					<div class="form-inline">
						<form>
							<input type="hidden" name="type" value="EtapeRepas"/>
							<div class="form-group">
								<label for="nom">Nom</label>
								<input type="text" class="form-control" id="nom" name="nom"  placeholder="Nom"/>
							</div>
							<div class="form-group">
								<label for="lieu">Lieu</label>
								<input type="text" class="form-control" id="lieu" name="lieu"  placeholder="Lieu"/>
							</div>
							<div class="form-group">
								<label for="dateHeure">Date et heure</label>
								<input type="text" class="form-control dateTimePicker" id="dateHeure" name="dateHeure"  placeholder="Date et heure"/>
							</div>
							<button id="button_ajouter_etapeRepas" class="btn btn-default">Ajouter</button>
						</form>
					</div>
				</div>
			</div>
		</div>

		<script type="application/javascript" src="ressources/jquery-ui-1.11.4.custom/external/jquery/jquery.js"></script>
		<script type="application/javascript" src="ressources/jquery-ui-1.11.4.custom/jquery-ui.min.js"></script>
		<script type="application/javascript" src="ressources/bootstrap-datepicker-1.5.1-dist/js/bootstrap-datepicker.min.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxcore.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxbuttons.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxscrollbar.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxmenu.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxgrid.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxgrid.edit.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxgrid.selection.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxgrid.columnsresize.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxgrid.filter.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxgrid.sort.js"></script>
		<script type="text/javascript" src="ressources/jqwidgets-ver4.1.1/jqxdata.js"></script> 
		<script type="application/javascript" src="ressources/jqwidgets-ver4.1.1/jqxscrollbar.js"></script>
		<script type="application/javascript" src="ressources/jqwidgets-ver4.1.1/jqxdropdownlist.js"></script>
		<script type="application/javascript" src="ressources/jqwidgets-ver4.1.1/jqxlistbox.js"></script>
		<script type="application/javascript" src="ressources/common.js"></script>
		<script type="application/javascript">
		var idMariage = "";
		var donneesDejaChargees = false;
		
		// Affiche la popup des invités
		var affichePopupEtapeRepas = function() { $("#popupAjoutEtapeRepas").dialog("open"); };
		var affichePopupEtapeCeremonie = function() { $("#popupAjoutEtapeCeremonie").dialog("open"); };

		// Fonction JqxGrid
		var modifieEtape = function(e) {
			majAttribute(REST_PREFIX + "/mariage/" + idMariage + "/etape", e, chargeEtapes);
		}
		
		// Sauvegarde etape par un POST
		var ajouteEtape = function(e, idPopup) {
			e.preventDefault();
			
			var data = $("#" + idPopup + " form").serialize();
			var req = $.ajax({ type: "POST", url: REST_PREFIX + "/mariage/" + idMariage + "/etape", data: data});
			req.success(function(dataString) {
				$("#" + idPopup).dialog("close");
				chargeEtapes();
			});
			req.fail(function(jqXHR, textStatus, errorThrown) {ajaxFailFunctionToDisplayWarn("ajouteEtape");});
		};
		var ajouteEtapeCeremonie = function(e) { ajouteEtape(e, "popupAjoutEtapeCeremonie") };
		var ajouteEtapeRepas = function(e) { ajouteEtape(e, "popupAjoutEtapeRepas") };
		
		
		var supprimeEtape = function(idEtape) {
			var req = $.ajax({ type: "DELETE", url: REST_PREFIX + "/mariage/" + idMariage + "/etape/" + idEtape});
			req.success(function(dataString) { chargeEtapes(); });
			req.fail(function(jqXHR, textStatus, errorThrown) {ajaxFailFunctionToDisplayWarn("supprimeEtape");});
		};
		
		// Chargement des données du mariage
		var chargeDonneesMariage = function() {
			var req = $.get( REST_PREFIX + "/mariage/" + idMariage);
			req.success(function(dataString) {
				var data = eval(dataString);
				$("#maries span:first").html(data.marie1);
				$("#maries span:last").html(data.marie2);
				$("#date span").html(data.dateCelebration);
			});
			req.fail(function(jqXHR, textStatus, errorThrown) {ajaxFailFunctionToDisplayWarn("readMariage");});
		};

		// Chargement des etapes
		var chargeEtapes = function() {
			if (donneesDejaChargees) {
				$("#etapes").jqxGrid('updatebounddata', 'cells');
			} else {
				var dataAdapter = new $.jqx.dataAdapter({
					datatype: "json",
					url: REST_PREFIX + "/mariage/" + idMariage + "/etape",
					datafields: [{ name: 'id', type: 'string' },{ name: 'lieu', type: 'string' },{ name: 'nom', type: 'string' },{ name: 'type', type: 'string' },{ name: 'dateHeure', type: 'string' }],
					id: 'id'
				});
				var rendererColonneBouton = function (rowIndex, columnfield, value, defaulthtml, columnproperties) { return '<a href="javascript:supprimeEtape(' + value + ')" id="btn' + value + '"><span class="ui-icon ui-icon-trash"></span></a>' };
				$("#etapes").jqxGrid({
					source: dataAdapter,
					columns: [
						{ text: 'Type', datafield: 'type', width: "15%" },
						{ text: 'Nom', datafield: 'nom', width: "25%" },
						{ text: 'Date et heure', datafield: 'dateHeure', width: "25%" },
						{ text: 'Lieu', datafield: 'lieu', width: "25%" },
						{ text: 'Actions', datafield: 'id', width: "10%", editable: false, sortable: false, menu: false, cellsrenderer: rendererColonneBouton }
					],
					editable: true,
					sortable: true,
					filterable: true,
					autoheight: true,
					width: 950
				});
				$("#etapes").on('cellendedit', modifieEtape);
				donneesDejaChargees = true;
			}
		};

		$(document).ready(function() {
		
			// Redirection si pas de mariage sélectionné
			idMariage = getIdMariage();
			if (idMariage === "") {window.location.href="/";}
			
			chargeDonneesMariage();

			chargeEtapes();
			
			// Ajout des evenements
			$("#button_afficher_popup_ajouter_ceremonie").on("click", affichePopupEtapeCeremonie);
			$("#button_afficher_popup_ajouter_repas").on("click", affichePopupEtapeRepas);
			$("#button_ajouter_etapeCeremonie").on("click", ajouteEtapeCeremonie);
			$("#button_ajouter_etapeRepas").on("click", ajouteEtapeRepas);
		});
		</script>
	</body>
</html>